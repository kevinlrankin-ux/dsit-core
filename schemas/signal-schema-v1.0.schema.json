{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "DSIT Signal Schema v1.0",
  "type": "object",
  "required": [
    "case_id",
    "media_type",
    "input_hash",
    "quality",
    "signals",
    "provenance",
    "aggregation",
    "limits",
    "version"
  ],
  "properties": {
    "case_id": {
      "type": "string"
    },
    "media_type": {
      "type": "string",
      "enum": [
        "image",
        "audio",
        "video",
        "unknown"
      ]
    },
    "input_hash": {
      "type": "string",
      "description": "sha256 of original input bytes"
    },
    "quality": {
      "type": "object",
      "required": [
        "quality_score",
        "factors"
      ],
      "properties": {
        "quality_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "factors": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "artifact_density": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Informational only; affects uncertainty/quality, not outcome authority."
        },
        "artifact_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of frames/screenshots/clips used for evaluation."
        }
      }
    },
    "signals": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "id",
          "category",
          "strength",
          "description",
          "false_positive_risks"
        ],
        "properties": {
          "id": {
            "type": "string"
          },
          "category": {
            "type": "string",
            "enum": [
              "image",
              "audio",
              "video",
              "cross_modal",
              "provenance"
            ]
          },
          "strength": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          },
          "description": {
            "type": "string"
          },
          "false_positive_risks": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      }
    },
    "provenance": {
      "type": "object",
      "required": [
        "metadata_present",
        "reencoding_detected",
        "capture_signature",
        "tamper_evidence"
      ],
      "properties": {
        "metadata_present": {
          "type": [
            "boolean",
            "string"
          ],
          "enum": [
            true,
            false,
            "unknown"
          ]
        },
        "reencoding_detected": {
          "type": "string",
          "enum": [
            "true",
            "false",
            "unknown"
          ]
        },
        "capture_signature": {
          "type": "string",
          "enum": [
            "absent",
            "unverified",
            "verified",
            "unknown"
          ]
        },
        "tamper_evidence": {
          "type": "string",
          "enum": [
            "pass",
            "fail",
            "unknown"
          ]
        }
      }
    },
    "aggregation": {
      "type": "object",
      "required": [
        "risk_score",
        "traffic_light",
        "thresholds"
      ],
      "properties": {
        "risk_score": {
          "type": [
            "number",
            "null"
          ],
          "minimum": 0,
          "maximum": 1
        },
        "traffic_light": {
          "type": "string",
          "enum": [
            "green",
            "yellow",
            "red"
          ]
        },
        "thresholds": {
          "type": "object",
          "required": [
            "green_lt",
            "red_gte",
            "quality_min_green",
            "quality_min_any",
            "red_override_if_low_quality"
          ],
          "properties": {
            "green_lt": {
              "type": "number"
            },
            "red_gte": {
              "type": "number"
            },
            "quality_min_green": {
              "type": "number"
            },
            "quality_min_any": {
              "type": "number"
            },
            "red_override_if_low_quality": {
              "type": "number"
            }
          }
        }
      }
    },
    "limits": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "optional_next_steps": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "version": {
      "type": "string",
      "const": "signal-schema-v1.0"
    },
    "governance": {
      "type": "object",
      "properties": {
        "invariants": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1
        }
      }
    }
  },
  "allOf": [
    {
      "not": {
        "properties": {
          "aggregation": {
            "properties": {
              "thresholds": {
                "required": [
                  "artifact_density"
                ]
              }
            }
          }
        }
      }
    },
    {
      "not": {
        "properties": {
          "signals": {
            "contains": {
              "properties": {
                "id": {
                  "const": "artifact_density"
                }
              },
              "required": [
                "id"
              ]
            }
          }
        }
      }
    },
    {
      "not": {
        "properties": {
          "signals": {
            "contains": {
              "properties": {
                "category": {
                  "const": "artifact_density"
                }
              },
              "required": [
                "category"
              ]
            }
          }
        }
      }
    },
    {
      "not": {
        "properties": {
          "aggregation": {
            "properties": {
              "thresholds": {
                "patternProperties": {
                  ".*density.*": {}
                }
              }
            }
          }
        }
      }
    }
  ]
}